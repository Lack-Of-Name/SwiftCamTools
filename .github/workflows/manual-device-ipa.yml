name: Manual Device IPA Build

on:
  workflow_dispatch:
    inputs:
      configuration:
        description: "Xcode build configuration"
        required: false
        default: Release
      export_method:
        description: "Export method (development, ad-hoc, app-store, enterprise)"
        required: false
        default: development
      provisioning_profile_name:
        description: "Provisioning profile specifier configured in the project"
        required: false
        default: SwiftCamToolsDevProfile
      cert_p12_base64:
        description: "Base64-encoded .p12 signing certificate"
        required: true
      cert_password:
        description: "Password for the .p12 certificate"
        required: true
      provisioning_profile_base64:
        description: "Base64-encoded provisioning profile (.mobileprovision)"
        required: true
      team_id:
        description: "Apple Developer Team ID"
        required: true

jobs:
  build-device-ipa:
    runs-on: macos-latest
    timeout-minutes: 35
    env:
      SCHEME: SwiftCamTools
      XCODE_APP: /Applications/Xcode.app
      BUNDLE_IDENTIFIER: com.swiftcamtools.app
      CONFIGURATION: ${{ inputs.configuration }}
      EXPORT_METHOD: ${{ inputs.export_method }}
      PROFILE_NAME: ${{ inputs.provisioning_profile_name }}
      IOS_CERT_P12: ${{ inputs.cert_p12_base64 }}
      IOS_CERT_PASSWORD: ${{ inputs.cert_password }}
      IOS_PROVISIONING_PROFILE: ${{ inputs.provisioning_profile_base64 }}
      IOS_TEAM_ID: ${{ inputs.team_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest Xcode
        run: sudo xcode-select -s "$XCODE_APP/Contents/Developer"

      - name: Install tooling
        run: |
          brew update
          brew install xcodegen xcbeautify

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Resolve Swift package dependencies
        run: |
          xcodebuild \
            -scheme "$SCHEME" \
            -resolvePackageDependencies \
            -clonedSourcePackagesDirPath DerivedData/SourcePackages

      - name: Install signing assets
        env:
          P12_BASE64: ${{ env.IOS_CERT_P12 }}
          P12_PASSWORD: ${{ env.IOS_CERT_PASSWORD }}
          PROFILE_BASE64: ${{ env.IOS_PROVISIONING_PROFILE }}
          TEAM_ID: ${{ env.IOS_TEAM_ID }}
        run: |
          if [ -z "$P12_BASE64" ] || [ -z "$P12_PASSWORD" ] || [ -z "$PROFILE_BASE64" ] || [ -z "$TEAM_ID" ]; then
            echo "Missing signing secrets (IOS_CERT_P12, IOS_CERT_PASSWORD, IOS_PROVISIONING_PROFILE, IOS_TEAM_ID)." >&2
            exit 1
          fi
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          echo "$P12_BASE64" | base64 --decode > signing_cert.p12
          security import signing_cert.p12 -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychain -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          PROFILE_PATH="$PROFILE_DIR/SwiftCamTools.mobileprovision"
          echo "$PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "TEAM_ID=$TEAM_ID" >> $GITHUB_ENV
          echo "PROFILE_PATH=$PROFILE_PATH" >> $GITHUB_ENV

      - name: Archive for iOS devices
        env:
          TEAM_ID: ${{ env.IOS_TEAM_ID }}
        run: |
          set -o pipefail
          xcodebuild \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath build/SwiftCamTools \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            clean archive \
            | tee archive.log \
            | xcbeautify

      - name: Export signed IPA
        env:
          TEAM_ID: ${{ env.IOS_TEAM_ID }}
        run: |
          cat <<EOF > ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${EXPORT_METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_IDENTIFIER}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild \
            -exportArchive \
            -archivePath build/SwiftCamTools.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath export \
            | tee export.log \
            | xcbeautify

      - name: Upload device IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: SwiftCamTools-device-ipa
          path: |
            archive.log
            export.log
            build/SwiftCamTools.xcarchive
            export/*.ipa
